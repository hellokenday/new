var url = require("url");
module.exports.rewriteLinks = function (userServer) {
    var host = userServer.hostname;
    var string = host;
    var port = userServer.port;
    if (host && port) {
        if (parseInt(port, 10) !== 80) {
            string = host + ":" + port;
        }
    }
    var reg = new RegExp(
    // a simple, but exact match
    "https?:\\\\/\\\\/" +
        string +
        "|" +
        // following ['"] + exact
        "('|\")\\/\\/" +
        string +
        "|" +
        // exact match with optional trailing slash
        "https?://" +
        string +
        "(?!:)(/)?" +
        "|" +
        // following ['"] + exact + possible multiple (imr srcset etc)
        "('|\")(https?://|/|\\.)?" +
        string +
        "(?!:)(/)?(.*?)(?=[ ,'\"\\s])", "g");
    return {
        match: reg,
        //match: new RegExp("https?:\\\\/\\\\/" + string + "|https?://" + string + "(\/)?|('|\")(https?://|/|\\.)?" + string + "(\/)?(.*?)(?=[ ,'\"\\s])", "g"),
        //match: new RegExp("https?:\\\\?/\\\\?/" + string + "(\/)?|('|\")(https?://|\\\\?/|\\.)?" + string + "(\/)?(.*?)(?=[ ,'\"\\s])", "g"),
        //match: new RegExp('https?://' + string + '(\/)?|(\'|")(https?://|/|\\.)?' + string + '(\/)?(.*?)(?=[ ,\'"\\s])', 'g'),
        //match: new RegExp("https?:\\\\/\\\\/" + string, "g"),
        fn: function (req, res, match) {
            var proxyUrl = req.headers["host"];
            /**
             * Reject subdomains
             */
            if (match[0] === ".") {
                ret